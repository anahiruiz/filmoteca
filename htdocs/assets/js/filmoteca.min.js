/* globals $, Config */


/**
 * frontend/exhibitions/index
 */
$(document).ready(function () {

    'use strict';

    var $exhibitionsIndex = $('.exhibitions.index');
    var moreSchedulesSelector = '.more-schedules';

    $(moreSchedulesSelector).collapse({
        toggle: false
    });

    $exhibitionsIndex.on('click', moreSchedulesSelector , function (event) {

        var $element = $(event.target);
        var $collapsible = $element.siblings('.collapse');
        var config = {
            url: $element.data('href'),
            accepts: 'text/html',
            dataType: 'html',
            data: {
                since: $element.data('since')
            }
        };

        if ($element.data('loaded')) {
            $collapsible.collapse('toggle');
            return;
        }

        $element.addClass('loading');

        $.ajax(config)
            .success(function (response) {
                $collapsible.html(response).collapse('show');

                $element.data('loaded', true);
            })
            .fail(function () {
                $collapsible.collapse('hide');
            })
            .always(function () {
                $element.removeClass('loading');
            });
    });

    var $filmsSearcher = $('#films-searcher');

    $filmsSearcher.autocomplete({
        minLength: 0,
        source: function(request, response) {
            $.ajax({
                url: Config.routes.exhibitions_frontend_exhibitions_filmssearcher,
                dataType: "json",
                data: {
                    title: request.term
                },
                success: function(data) {
                    response(data);
                }
            });
        },
        select: function (event, ui) {
            var url = Config.routes.exhibitions_frontend_exhibitions_index;
            var query = 'title=' + ui.item.value;

            window.location = url + '?' + query
        }
    });
});
